# Telegram MP3 播放工具（基于现有项目简化）产品设计

更新时间：2026-02-12

## 1. 产品定位

将当前“多渠道文件托管平台”简化为“基于 Telegram 存储的个人 MP3 播放工具”。

核心价值：

1. **零额外对象存储成本**：直接复用 Telegram 作为文件后端。
2. **随时可播**：网页端支持流式播放（Range），可快进/拖拽。
3. **轻量自部署**：保留现有 Cloudflare Pages Functions 架构，减少迁移成本。

## 2. 目标用户与核心场景

### 2.1 目标用户

- **个人用户（主）**：有自建能力，希望私有化管理和播放个人音乐。
- **小圈子共享用户（次）**：家庭/朋友少量共享歌库，需基础访问控制。

### 2.2 核心场景

1. 上传本地 MP3 到 Telegram 存储。
2. 在音乐库按目录/关键词查找歌曲。
3. 点击歌曲后立即播放，支持进度拖拽、暂停、上一首/下一首。
4. 下次打开可恢复最近播放记录。

## 3. 简化范围（KISS / YAGNI）

### 3.1 MVP 保留能力

- 上传（含大文件分片上传）
- 文件索引与列表
- 文件读取与 Range 播放
- 基础鉴权（管理密码或 Token）
- Telegram 渠道配置

### 3.2 MVP 下线或隐藏能力

- 图片审查、随机图、壁纸接口
- 多渠道复杂切换 UI（Discord、HuggingFace、外链等）
- 通用文件管理高级功能（批量改名、批量移动、复杂标签体系）
- 与“图床”定位相关的展示页面和术语

> 原则：优先保留音乐主链路必要代码，遗留模块按“无引用+无业务价值”规则删除。

## 4. Telegram 约束与设计依据（官方 Bot API）

基于 Telegram Bot API 文档（core.telegram.org/bots/api）：

1. `sendAudio` 适用于音乐消息，推荐 MP3/M4A，单文件上传上限 50MB。
2. `sendDocument` 可发送通用文件，单文件上传上限 50MB。
3. `getFile` 在官方云端下载时，Bot 侧可下载文件上限 20MB。
4. `file_path` 下载链接格式：`https://api.telegram.org/file/bot<token>/<file_path>`，有效期至少 1 小时。
5. 使用 `file_id` 可复用 Telegram 侧已存在文件（减少重复上传）。

对本项目的直接影响：

- 现有实现采用 **16MB 分片**（小于 20MB 下载限制），可支持大于 20MB 的 MP3 通过分块重组流式播放。
- 播放链路不应缓存长期直链，应按需通过 `getFile` 刷新 `file_path`。

## 5. 信息架构与页面设计（MVP）

仅保留 3 个页面：

1. **登录/设置页**
   - 输入管理密码（或 Token）
   - 检查 Telegram 配置连通性
2. **音乐库页**
   - 搜索、目录筛选、排序（最近上传/名称）
   - 上传按钮（支持拖拽）
   - 歌曲列表（标题、时长、大小、上传时间）
3. **播放页（或底部播放器）**
   - 封面占位、歌曲名、进度条、播放控制
   - 播放模式（顺序/单曲循环/随机）

## 6. 功能需求（MVP）

### 6.1 上传入库

- 支持 `.mp3` 为主（后续扩展 `.m4a/.flac`）。
- 超过阈值自动走分片上传。
- 上传成功后立即写入索引，失败可重试。

### 6.2 音乐库检索

- 默认展示音频文件（`type=audio`）。
- 支持关键词搜索（文件名）。
- 支持分页加载与按目录浏览。

### 6.3 流式播放

- 播放接口必须支持 `Range` / `206 Partial Content`。
- 前端使用 `<audio>` + 媒体事件管理缓冲与错误重试。
- 记录最近播放位置（本地存储）。

### 6.4 基础管理

- 最小配置项：Bot Token、Chat ID、代理域名（可选）。
- 提供“配置自检”：上传测试片段 + 回读验证。

## 7. 技术方案（复用现有代码）

### 7.1 后端复用点

- 上传入口：`functions/upload/index.js`
- Telegram 能力封装：`functions/utils/telegramAPI.js`
- 文件读取（含 Range）：`functions/file/[[path]].js`
- 分片上传与合并：`functions/upload/chunkUpload.js`、`functions/upload/chunkMerge.js`

### 7.2 需要新增/调整

1. **新增音乐专用 API 聚合层（推荐）**
   - `GET /api/music/list`
   - `POST /api/music/upload`
   - `GET /api/music/stream/:id`（可内部转发到 `/file/:id`）
2. **统一元数据结构**
   - 新增 `TrackTitle`、`Artist`、`Album`、`Duration`（可先留空，后续解析）
3. **前端重构为轻量播放器 UI**
   - 移除图床相关菜单、系统设置分区和无关能力入口

## 8. 数据模型（MVP）

文件主键：`fileId`

元数据建议：

- `FileName`
- `FileType`
- `FileSizeBytes`
- `TimeStamp`
- `Channel=TelegramNew`
- `TgFileId`（非分片）
- `IsChunked`、`TotalChunks`（分片）
- `TrackTitle`（可选，默认文件名）
- `Artist`（可选）
- `Album`（可选）

## 9. 非功能与验收指标

### 9.1 稳定性指标

- 上传成功率 ≥ 98%
- 点击播放成功率 ≥ 99%
- 流式播放中断率 ≤ 1%

### 9.2 性能指标

- 同地域首帧出声时间 P95 < 2s
- 音乐库首屏加载 P95 < 1.5s

### 9.3 安全指标

- 管理接口默认鉴权开启
- 不在前端暴露 Bot Token
- 日志中脱敏关键字段

## 10. 风险与应对

1. **Telegram 接口波动/限流**
   - 上传与分片读取增加指数退避重试
2. **大文件播放稳定性**
   - 默认分片阈值保持 16MB，避免触达 20MB 下载上限
3. **索引不一致（上传成功但入库失败）**
   - 增加补偿任务与失败队列
4. **浏览器自动播放策略限制**
   - 首次播放依赖用户手势触发

## 11. 里程碑路线图

### Phase 1（1 周）：可用 MVP

- 完成“上传-列表-播放”闭环
- 输出简化 UI（音乐库 + 播放器）
- 完成基础鉴权

### Phase 2（1~2 周）：可用性增强

- 播放队列、上一首/下一首、播放模式
- 最近播放记录与断点续播
- 上传/播放监控指标

### Phase 3（可选）：体验升级

- 歌单管理
- ID3 元数据解析（标题/歌手/专辑/封面）
- 分享链接与小范围访问控制

## 12. 实施原则映射

- **KISS**：保留 3 页面 + 3 核心能力，先跑通闭环。
- **YAGNI**：不提前建设歌词、推荐、社交等非刚需模块。
- **DRY**：复用现有上传、索引、读取链路，避免重复实现存储层。
- **SOLID**：通过 `music` 领域 API 与现有通用文件能力解耦，降低后续演进成本。
